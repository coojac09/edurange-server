file '/root/upload_bash_history' do
  x  = '#!/usr/bin/env bash'
  x += "\n"
  x += 'cat /home/*/.bash_history.log | curl -X PUT --data-binary @- -H "Content-Type: text/plain" "<%= instance.bash_history_page %>"'
  content x
  owner 'root'
  group 'root'
  mode '550'
end

cron 'schedule_upload_bash_history' do
  user 'root'
  command '/root/upload_bash_history'
end

ruby_block "bash_history_logging" do
    prompt_command = 'echo -e "$?\t$(date --utc +%FT%T.%3NZ)\t$(whoami)\t$(pwd)\t$(history 1 | cut -c 8-)" >> ~/.bash_history.log'
    set_prompt_command = "PROMPT_COMMAND='#{prompt_command}'"
    block do
      if File.exist?('/etc/bash.bashrc')
        file = Chef::Util::FileEdit.new('/etc/bash.bashrc')
        file.insert_line_if_no_match(/#{set_prompt_command}/, set_prompt_command)
        file.write_file
      else
        Chef::Log.warn('file \'/etc/bash.bashrc\' does not exist')
      end
    end
end
