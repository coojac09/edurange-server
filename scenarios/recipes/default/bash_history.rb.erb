file '/root/upload_bash_history' do
  x  = '#!/usr/bin/env bash'
  x += "\n"
  x += 'cat /home/*/.bash_history.log | curl -X PUT --data-binary @- -H "Content-Type: text/plain" "<%= instance.bash_history_page %>"'
  content x
  owner 'root'
  group 'root'
  mode '550'
end

cron 'schedule_upload_bash_history' do
  user 'root'
  command '/root/upload_bash_history'
end

ruby_block "bash_history_logging" do
    prompt_command = "history -a; histJSON=$(echo {\"user\": \"$(whoami)\", \"time\": $(date +%s), \"command\": \"$(tail -n 1 ~/.bash_history)\"}); curl -s -d "$histJSON" -H "Content-Type: application/json" -H "uuid: <%= instance.scenario.uuid %>" -H "secret: <%= instance.scenario.secret %>" -X POST [TARGET ADDRESS OF EDURANGE_SERVER] >> /dev/null"

    set_prompt_command = "PROMPT_COMMAND='#{prompt_command}'"
    start_loader = 'nohup /usr/bin/instantHistory/main.py &'
    block do
      if File.exist?('/etc/bash.bashrc')
        file = Chef::Util::FileEdit.new('/etc/bash.bashrc')
        file.insert_line_if_no_match(/#{set_prompt_command}/, set_prompt_command)
        file.insert_line_if_no_match(/#{start_loader}/, start_loader)
        file.write_file
      else
        Chef::Log.warn('file \'/etc/bash.bashrc\' does not exist')
      end
    end
end
