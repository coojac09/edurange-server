file '/root/upload_bash_history' do
  x  = '#!/usr/bin/env bash'
  x += "\n"
  x += 'cat /home/*/.bash_history.log | curl -X PUT --data-binary @- -H "Content-Type: text/plain" "<%= instance.bash_history_page %>"'
  content x
  owner 'root'
  group 'root'
  mode '550'
end

cron 'schedule_upload_bash_history' do
  user 'root'
  command '/root/upload_bash_history'
end

ruby_block "bash_history_logging" do
    definition_command = "export uuid=<%= instance.scenario.uuid %>"
    prompt_command='history -a; histJSON=$(echo {\"user\": \"$(whoami)\", \"time\": $(date +%s), \"command\": \"$(history 1 | cut -c 8-)\"}); curl -s -d "$histJSON" -H "Content-Type: application/json" -H "uuid: <%= instance.scenario.uuid %>" -X POST 10.0.129.5/logger >> /dev/null'

    set_prompt_command = "PROMPT_COMMAND='#{prompt_command}'"
    block do
      if File.exist?('/etc/bash.bashrc')
        file = Chef::Util::FileEdit.new('/etc/bash.bashrc')
        file.insert_line_if_no_match(/#{definition_command}/, definition_command)
        file.insert_line_if_no_match(/#{set_prompt_command}/, set_prompt_command)
        file.write_file
      else
        Chef::Log.warn('file \'/etc/bash.bashrc\' does not exist')
      end
    end
end
